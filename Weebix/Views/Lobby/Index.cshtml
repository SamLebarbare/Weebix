@{
    ViewBag.Title = "Index";
}
@section headscript
{
   <script src="/Scripts/jquery.signalR-1.0.1.min.js" type="text/javascript"></script>
   <script src="/signalr/hubs" type="text/javascript"></script>
   <script type="text/javascript">
       $(function () {

           //Party View Model
           function partyViewModel(id,name,status,createdAt, ownerViewModel) {
               this.partyId = id;
               this.name = ko.observable(path);
               this.status = ko.observable(status);

               this.remove = function () { ownerViewModel.removeCard(this.cardId) }
               this.notification = function (b) { notify = b }

               var self = this;
           }

           //Party List View Model
           function partyListViewModel() {

               this.hub = $.connection.lobbyHub;
               this.games = ko.observableArray([]);

               var games = this.deck;
               var self = this;
               var notify = true;

               //Initializes the view model
               this.init = function () {
                   this.hub.server.getAll();
               }

               //Handlers for our Hub callbacks

               this.hub.client.allGames = function (allGames) {

                   var mappedGames = $.map(allGames, function (item) {
                       return new partyViewModel(item.partyId, item.name,item.status,item.createdAt, self)
                   });

                   deck(mappedGames);
               }


               this.hub.client.reportError = function (error) {
                   $("#error").text(error);
                   $("#error").fadeIn(1000, function () {
                       $("#error").fadeOut(3000);
                   });
               }


               this.hub.client.partyRemoved = function (id) {
                   var party = ko.utils.arrayFilter(deck(), function (value) { return value.partyId == id; })[0];
                   deck.remove(party);
               };

               //View Model 'Commands'

               //To remove a party
               this.removeParty = function (id) {
                   this.hub.server.removeParty(id);
               }



           }

           $.connection.hub.logging = true;
           var vm = new partyListViewModel();
           ko.applyBindings(vm);
           // Start the connection
           $.connection.hub.start(function () { vm.init(); });

       });


   </script>
}
    

